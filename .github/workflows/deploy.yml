name: DCSL

on:
  push:
    branches: [ main ]

env:
  JAR_NAME: driver_charging_session_authenticator-1.0.0.jar
  LOCAL_JAR_PATH: libs/driver_charging_session_authenticator-1.0.0.jar
  APP_DIR: /home/ec2-user/dcsl

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Build JAR (skip tests)
        run: ./gradlew bootJar -x test

      - name: Ensure JAR exists
        run: |
          if [ ! -f "${{ env.LOCAL_JAR_PATH }}" ]; then
            echo "JAR file not found: ${{ env.LOCAL_JAR_PATH }}"
            exit 1
          fi

      - name: Copy files to EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p $APP_DIR"
          scp Dockerfile ${{ env.LOCAL_JAR_PATH }} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:$APP_DIR/

      - name: Deploy Docker container on EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd $APP_DIR
            docker stop dcsl || true
            docker rm dcsl || true
            docker build -t dcsl .
            docker run -d --name dcsl -p 3000:3000 dcsl
          EOF
